- include_role:
    name: common
    tasks_from: nodejs
  tags:
    - bootstrap

- name: install zmarkdown
  become: true
  become_user: zds
  npm:
    path: "{{ zmarkdown_dir }}"
    production: yes
  tags:
    - bootstrap
    - upgrade

- name: add zmarkdown unit file
  template:
    src: zmd.service.j2
    dest: /etc/systemd/system/zmd.service
  tags:
    - bootstrap
    - upgrade

- name: start zmarkdown service
  systemd:
    name: zmd
    state: started
    enabled: yes
    daemon_reload: true
  tags:
    - bootstrap

- name: reload zmarkdown service
  systemd:
    name: zmd
    state: reloaded
    daemon_reload: true
  tags:
    - bootstrap
    - upgrade

- name: ensure that zmarkdown is running
  uri:
    url: http://localhost:27272/
    return_content: yes
  register: this
  delay: 1
  retries: 10
  until: "'zmd is running' in this.content"
  tags:
    - bootstrap
    - upgrade
