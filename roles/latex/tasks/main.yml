- name: download latest texlive
  become: true
  become_user: zds
  ansible.builtin.unarchive:
    src: "{{ texlive_repository }}/install-tl-unx.tar.gz"
    dest: "{{ workdir }}"
    remote_src: true
  tags:
    - bootstrap

- name: copy texlive.profile
  become: true
  become_user: zds
  ansible.builtin.template:
    src: texlive.profile
    dest: "{{ workdir }}/texlive.profile"
  tags:
    - bootstrap

- name: install latest texlive
  become: true
  become_user: zds
  ansible.builtin.shell: |
    if [ -e installation.profile ]; then
        ./install-tl*/install-tl -v --repository {{ texlive_repository }} --profile installation.profile
    elif [ -d "{{ texlive_dir }}/bin" ]; then
        echo "TeXLive is already installed"
    else
        ./install-tl*/install-tl -v --repository {{ texlive_repository }} --profile texlive.profile
    fi
  args:
    executable: /bin/bash
    chdir: "{{ workdir }}"
  register: this
  until: this is succeeded
  delay: 5
  retries: 5
  notify: remove texlive installation files
  tags:
    - bootstrap

- name: include packages tasks
  include_tasks: packages.yml
  tags:
    - bootstrap
    - upgrade

- name: install fontconfig
  ansible.builtin.apt:
    pkg: fontconfig
    state: present
    cache_valid_time: 3600
  tags:
    - bootstrap

- name: create font folders
  ansible.builtin.file:
    path: /usr/local/share/fonts/{{ item[0].path }}/{{ item[1].slug }}/
    state: directory
    mode: u=rw,g=r,o=r
  with_nested:
    - "{{ fonttypes }}"
    - "{{ fonts }}"
  tags:
    - bootstrap

- name: download fonts
  ansible.builtin.get_url:
    url: "{{ item[0].url }}/{{ item[1].ext | upper }}/{{ item[0].name }}-{{ item[2] }}.{{ item[1].ext }}"
    dest: /usr/local/share/fonts/{{ item[1].path }}/{{ item[0].slug }}/{{ item[0].name }}-{{ item[2] }}.{{ item[1].ext }}
  with_nested:
    - "{{ fonts }}"
    - "{{ fonttypes }}"
    - - Black
      - BlackIt
      - Bold
      - BoldIt
      - ExtraLight
      - ExtraLightIt
      - It
      - Light
      - LightIt
      - Regular
      - Semibold
      - SemiboldIt
  notify: refresh font-config cache
  tags:
    - bootstrap
